---
rules:
    - ../../rules.hrf
    - ../../../../Cardinal Care Core/rules.hrf
    - immunocompromised_age_5_to_11.hrf
---

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Limitations from Schedule of Benefits
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%% Referenced in the superfolder benefit rules file

meets_or_exceeds_2024_cdc_acip_age_guideline_max_by_age(0, Claim) :-
    ~patient_geq_6_months_old_at_time_of_service(Claim)

meets_or_exceeds_2024_cdc_acip_age_guideline_max_by_age(Age, Claim) :-
    patient_age_bracket_for_covid19_vaccination(Claim, Age, AgeBracket) &
    claim.patient_is_immunocompromised(Claim, ImmStatus) & 
    claim.covid19_vaccine_brand(Claim, Brand) &
    ~allowed_one_more_updated_2024_2025_covid19_vaccine_with_brand(ImmStatus, AgeBracket, Brand, Claim)

%%% Age Brackets %%%
patient_age_bracket_for_covid19_vaccination(Claim, Age, 6_months_to_4_years) :-
    patient_geq_6_months_old_at_time_of_service(Claim) &
    leq(Age, 4)

patient_age_bracket_for_covid19_vaccination(Claim, Age, 5_to_11_years) :-
    leq(5, Age) &
    leq(Age, 11)

patient_age_bracket_for_covid19_vaccination(Claim, Age, 12_to_64_years) :-
    leq(12, Age) &
    leq(Age, 64)

patient_age_bracket_for_covid19_vaccination(Claim, Age, 65_years_and_older) :-
    leq(65, Age)

%%% Computing dose counts %%%
num_old_2024_2025_covid19_vaccines_with_brand(Vaccines, Brand, NumNotUpdatedOfBrand) :-
    countofall(I, choose_1_with_index_from_list(Vaccines, covid19_vaccination(Brand, UpdatedStatus, Date), I) & distinct(UpdatedStatus, updated_2024_2025), NumNotUpdatedOfBrand)

num_updated_2024_2025_covid19_vaccines_with_brand(Vaccines, Brand, NumUpdatedOfBrand) :-
    countofall(I, choose_1_with_index_from_list(Vaccines, covid19_vaccination(Brand, updated_2024_2025, Date), I), NumUpdatedOfBrand)


mrna_vaccine(moderna)
mrna_vaccine(pfizer_biontech)

num_updated_mrna_vaccines_in_claim(Claim, NumUpdated) :-
    claim.covid19_vaccine_history(Claim, Vaccines) &
    num_updated_2024_2025_covid19_vaccines_with_brand(Vaccines, moderna, NumUpdatedModerna) &
    num_updated_2024_2025_covid19_vaccines_with_brand(Vaccines, pfizer_biontech, NumUpdatedPfizer) &
    evaluate(plus(NumUpdatedModerna, NumUpdatedPfizer), NumUpdated)

num_old_mrna_vaccines_in_claim(Claim, NumOld) :-
    claim.covid19_vaccine_history(Claim, Vaccines) &
    num_old_2024_2025_covid19_vaccines_with_brand(Vaccines, moderna, NumOldModerna) &
    num_old_2024_2025_covid19_vaccines_with_brand(Vaccines, pfizer_biontech, NumOldPfizer) &
    evaluate(plus(NumOldModerna, NumOldPfizer), NumOld)

num_mrna_vaccines_in_claim(Claim, NumMrna) :-
    num_updated_mrna_vaccines_in_claim(Claim, NumUpdated) &
    num_old_mrna_vaccines_in_claim(Claim, NumOld) &
    evaluate(plus(NumUpdated, NumOld), NumMrna)

%%%%%%%%%%%%%%%%%%%% Covid19 Maximums %%%%%%%%%%%%%%%%%%%%

% Imported from other rules files in this directory


%%%%%% Routine (not immunocompromised) %%%%%%

%%% Age 6 months-4 years %%%

%%% Age 5-11 %%%

%%% Age 12-64 %%%

%%% Age 65+ %%%


%%%%%% Immunocompromised %%%%%%

%%% Age 6 months-4 years %%%

%%% Age 5-11 %%%

%%% Age 12-64 %%%

%%% Age 65+ (same as 12-64) %%%
